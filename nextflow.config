// Process-specific configurations
profiles {
    
    dsi{
        docker.enabled=true
    }

    offline {
        docker.enabled=true
        process {
            cpus = 100
            memory = '400 GB'
            maxForks=16

            // Process-specific resource requirements (no queue/clusterOptions)
            withLabel:process_single {
                cpus = 1
                memory = { 6.GB * task.attempt }
                time = { 4.h * task.attempt }
            }

            withLabel:process_low {
                cpus = { 2 * task.attempt }
                memory = { 12.GB * task.attempt }
                time = { 2.h * task.attempt }
            }

            withLabel:process_medium {
                cpus = { 9 * task.attempt }
                memory = { 36.GB * task.attempt }
                time = { 9.h * task.attempt }
            }

            withLabel:process_high {
                cpus = { 12 * task.attempt }
                memory = { 72.GB * task.attempt }
                time = { 14.h * task.attempt }
            }

            withLabel:process_cellbender{
                cpus = { 64 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
            }

            withLabel:process_long {
                cpus = 9
                memory = 96.GB
                time = { 14.h * task.attempt }
            }

            withLabel:process_high_memory {
                cpus = { 40 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
            }

            withLabel:process_gpu {
                cpus = 10
                memory = '120.GB'
                time = '4.h'
            }

            withLabel:process_higher_memory {
                cpus = { 20 * task.attempt }
                memory = { 400.GB * task.attempt }
                time = { 12.h * task.attempt }
            }

            withLabel:process_reports {
                cpus = 16
                memory = '30.GB'
                time = '1.h'
            }

            withLabel:process_dropletqc {
                cpus = 16
                memory = '80.GB'
                time = '1.h'
            }
        }
    }



    imperial {

        docker.enabled = false
        singularity.enabled = true


        process {
            executor = 'pbspro'

            // General resource requirements
            errorStrategy = 'retry'
            maxRetries = 5
            maxErrors = '-1'
            queue = { 4 * task.attempt > 8 ? 'v1_small72' : 'v1_small24' }
            cpus = { 1 * task.attempt }
            memory = { 6.GB * task.attempt }
            time = { 4.h * task.attempt }

            // Process-specific resource requirements
            withLabel:process_single {
                cpus = 1
                memory = { 6.GB * task.attempt }
                time = { 4.h * task.attempt }
            }

            withLabel:process_low {
                cpus = { 2 * task.attempt }
                memory = { 12.GB * task.attempt }
                time = { 2.h * task.attempt }
            }

            withLabel:process_medium {
                queue = 'v1_medium72'
                cpus = { 9 * task.attempt }
                memory = { 36.GB * task.attempt }
                time = { 9.h * task.attempt }
            }

            withLabel:process_high {
                queue = 'v1_medium72'
                cpus = { 12 * task.attempt }
                memory = { 72.GB * task.attempt }
                time = { 14.h * task.attempt }
            }

            withLabel:process_cellbender{
                queue = 'v1_medium24'
                cpus = { 64 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
                
            }

            withLabel:process_long {
                queue = 'v1_medium72'
                cpus = 9
                memory = 96.GB
                time = { 14.h * task.attempt }
            }

            withLabel:process_high_memory {
                queue = { 200 * task.attempt < 921 ? 'v1_medium72' : 'v1_largemem72' }
                cpus = { 40 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
            }

            withLabel:process_gpu {
                queue = 'v1_gpu72'
                cpus = 10
                memory = '120.GB'
                time = '4.h'
                clusterOptions = "-l select=1:ncpus=10:mem=120gb:ngpus=1"
            }

            withLabel:process_higher_memory {
                queue = { 200 * task.attempt < 921 ? 'v1_medium72' : 'v1_largemem72' }
                cpus = { 20 * task.attempt }
                memory = { 400.GB * task.attempt }
                time = { 12.h * task.attempt }
            }

            withLabel:process_reports {
                queue = 'v1_small24'
                cpus = 16
                memory = '30.GB'
                time = '1.h'
            }

            withLabel:process_dropletqc {
                queue = 'v1_small24'
                cpus = 16
                memory = '80.GB'
                time = '1.h'
            }

            
        }
    }

        slurm {
        process {
            executor = 'slurm'
            queue = 'debug'
            
            withLabel:process_single {
                cpus = 1
                memory = { 6.GB * task.attempt }
                time = { 4.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_low {
                cpus = { 2 * task.attempt }
                memory = { 12.GB * task.attempt }
                time = { 2.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_medium {
                cpus = { 9 * task.attempt }
                memory = { 36.GB * task.attempt }
                time = { 9.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_high {
                cpus = { 12 * task.attempt }
                memory = { 72.GB * task.attempt }
                time = { 14.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_cellbender {
                cpus = { 32 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export CELLRANGER_TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_long {
                cpus = 9
                memory = 96.GB
                time = { 14.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_high_memory {
                cpus = { 40 * task.attempt }
                memory = { 200.GB * task.attempt }
                time = { 24.h * task.attempt }
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export CELLRANGER_TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_gpu {
                cpus = 10
                memory = '120.GB'
                time = '4.h'
                clusterOptions = '--exclude=landmark-lv-01 --gres=gpu:1'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_higher_memory{
                // Optimized for your SLURM cluster
                // Each compute node has 324GB RAM, 160 CPUs
                cpus = 30
                memory = 280.GB
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                
                // Set environment variables for temp directories
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export CELLRANGER_TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_reports {
                cpus = 16
                memory = '30.GB'
                time = '1.h'
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }

            withLabel:process_dropletqc {
                cpus = 16
                memory = '80.GB'
                time = '1.h'
                clusterOptions = '--exclude=landmark-lv-01'
                scratch = '/mnt/share/alex/tmp'
                beforeScript = '''
                export TMPDIR=/mnt/share/alex/tmp
                export TMP=/mnt/share/alex/tmp
                export TEMP=/mnt/share/alex/tmp
                mkdir -p $TMPDIR
                '''
            }
        }
    }


}